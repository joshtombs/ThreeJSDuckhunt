
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>DUCKHUNT!</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
      body {
        background:#030;
        color:#fff;
        padding:0;
        margin:0;
        overflow:hidden;
        font-family:georgia;
        text-align:center;
      }
    </style>
  </head>

  <body>
    <script src="js/three.min.js"></script>    
    <script src="js/Detector.js"></script>

    <script>
      window.vertLook = 0.5;
      window.horzLook = 0.5;
      var mouse = new THREE.Vector3();
      var projector = new THREE.Projector(),
      offset = new THREE.Vector3(),
      INTERSECTED, SELECTED;


      window.document.addEventListener("mousemove", function(e) {
        window.vertLook = e.y/window.innerHeight;
        window.horzLook = e.x/window.innerWidth;

        mouse.x = 2 * (e.clientX / window.innerWidth) -1;
        mouse.y = 1 - 2 * (e.clientY / window.innerHeight);

        var raycaster = projector.pickingRay( mouse.clone(), camera );
        window.intersects = raycaster.intersectObjects( birds );

        document.body.style.cursor = 'crosshair';
        }
      );
  
      window.document.addEventListener("mousedown", function(e){
        e.preventDefault();

        if ( intersects.length > 0 ) {
          // intersects[0].object.material = new THREE.MeshBasicMaterial({color:'blue'});
          deadBirds.push(intersects[0].object);
          scene.remove(intersects[0].object)
        }
        console.log(deadBirds);
      });

      window.document.addEventListener("mouseup", function(e){
          e.preventDefault();
          
      });

      if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
      var camera, scene, renderer,
      mesh, levels = [];

      init();
      animate();

      function init() {
        document.body.style.cursor = 'crosshair';
        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.set( 0, 50, 205 );
        scene = new THREE.Scene();
        DrawGrass();
        DrawSun();
        generateGun();
        generateBirds();
        renderer = new THREE.WebGLRenderer();
        renderer.sortObjects = false;
        renderer.setClearColor( 0x7ec0ee );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );
        //
        window.addEventListener( 'resize', onWindowResize, false );

      }

      function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );

      }

      function DrawGrass(){
          var newplane = new THREE.Mesh( new THREE.PlaneGeometry(window.innerWidth,255), new THREE.MeshLambertMaterial({color: 0x003300}));
          newplane.position.z +=30;
          newplane.rotation.x = - Math.PI / 2;
          scene.add(newplane);

          // var geometry = new THREE.PlaneGeometry( 455, 175 );
          // var bitmap = generateTextureBase();

          // for ( var i = 0; i < 15; i ++ ) {

          //   mesh = levels[ i ] = new THREE.Mesh( geometry, new THREE.MeshBasicMaterial( { map: new THREE.Texture( generateTextureLevel( bitmap ) ), transparent: true, depthWrite: false, depthTest: false } ) );
          //   mesh.material.map.needsUpdate = true;

          //   mesh.position.y = i * 0.25;
          //   mesh.rotation.x = - Math.PI / 2;

          //   scene.add( mesh );

          // }
      }

      function DrawSun(){
        scene.add(new THREE.HemisphereLight(0x6E91FF, 0x00FF00, 5))
        var sunsphere = new THREE.Mesh( new THREE.SphereGeometry(100,100,100), new THREE.MeshLambertMaterial({color: 'yellow'}));
        sunsphere.position.z=-200;
        scene.add(sunsphere);
      }

      function generateBirds(){
        window.numBirds = 25;
        window.birds = [];
        window.deadBirds = [];
        var bird;
        for( var i = 0; i < window.numBirds; i++){
          bird = new THREE.Mesh( new THREE.SphereGeometry(3,10,10), new THREE.MeshLambertMaterial({color:'red'}));
          bird.position.set(40, Math.floor(Math.random() * (70-40)+40),Math.floor(Math.random() * (110-60)+60));
          bird.velocity = {
            x: Math.random()*(1-0.3)+0.3
            // y: Math.random()/10
          }
          birds.push(bird);
          scene.add(bird);
        }
      }

      function generateGun(){
        var gun = new THREE.Mesh( new THREE.BoxGeometry(40,5,5), new THREE.MeshLambertMaterial({color:'brown'}));
        gun.position.set(0,40,170);
        window.Gun = gun;
        scene.add(gun);
      }

      function generateTextureBase() {

        var canvas = document.createElement( 'canvas' );
        canvas.width = 512;
        canvas.height = 512;

        var context = canvas.getContext( '2d' );

        for ( var i = 0; i < 20000; i ++ ) {

          context.fillStyle = 'rgba(0,' + Math.floor( Math.random() * 64 + 32 ) + ',16,1)';
          context.beginPath();
          context.arc( Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 1 + 0.5, 0, Math.PI * 2, true );
          context.fill();

        }

        return canvas;
      }

      function generateTextureLevel( texture ) {

        texture.getContext( '2d' ).drawImage( texture, 0, 0 );

        var canvas = document.createElement( 'canvas' );
        canvas.width = texture.width;
        canvas.height = texture.height;

        canvas.getContext( '2d' ).drawImage( texture, 0, 0 );

        return canvas;

      }

      //

      function animate() {

        requestAnimationFrame( animate );

        render();

      }

      function flyBirds(){
        for(var i = 0; i < window.birds.length; i++) {
          if(birds[i].position.x > (window.innerWidth / 10)) {
            birds[i].position.x = (-window.innerWidth / 10);            
          }
          else {
            birds[i].position.x += birds[i].velocity.x;             
            // birds[i].position.y += birds[i].velocity.y * Math.floor(Math.random()*2+1);
          }
        }
      }
      function render() {

        var time = Date.now() / 6000;

        camera.lookAt( scene.position );
        // camera.rotateX((1 - vertLook) *Math.PI/2)
        Gun.lookAt( scene.position );
        Gun.rotateY((((horzLook)*-2))* Math.PI/2);
        Gun.rotateZ((1 - vertLook) * (Math.PI - 2)/2);
        Gun.rotateY(0);
        flyBirds();
        for ( var i = 0, l = levels.length ; i < l; i ++ ) {

          mesh = levels[ i ];
          mesh.position.x = Math.sin( time * 4 ) * i * i * 0.005;
          mesh.position.z = Math.cos( time * 6 ) * i * i * 0.005;

        }

        renderer.render( scene, camera );

      }

    </script>

  </body>
</html>
