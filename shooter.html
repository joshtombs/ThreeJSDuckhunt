
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>DUCKHUNT!</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
      body {
        background:#030;
        color:#fff;
        padding:0;
        margin:0;
        overflow:hidden;
        font-family:georgia;
        text-align:center;
      }
    </style>
  </head>

  <body>
    <script src="js/three.min.js"></script>    
    <script src="js/Detector.js"></script>

    <script>
      window.app = {};
      window.app.vertLook = 0.5;
      window.app.horzLook = 0.5;
      window.app.skyColor = 0x6E91FF;
      var mouse = new THREE.Vector3();
      var projector = new THREE.Projector();
      var camera, scene, renderer, mesh, levels = [];
      
      // if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

      init();
      animate();

      function init() {
        document.body.style.cursor = 'crosshair';
        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.set( 0, 50, 205 );
        createScenery();
        generateGun();
        generateBirds();
        renderer = new THREE.WebGLRenderer();
        renderer.sortObjects = false;
        renderer.setClearColor( 0x7ec0ee );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );
        //
        window.addEventListener( 'resize', onWindowResize, false );
        window.document.addEventListener("mousemove", onMouseMove);
        window.document.addEventListener("mousedown", onMouseDown);
        window.document.addEventListener("mouseup", onMouseUp);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );

      }

      function createScenery(){
        scene = new THREE.Scene();
        scene.fog = new THREE.Fog( 0xEBEBEB, 0, 500);
        skyPlane = new THREE.Mesh( new THREE.PlaneGeometry(window.innerWidth, window.innerHeight), new THREE.MeshBasicMaterial({color: app.skyColor}));
        skyPlane.position.z -= 150;
        scene.add(skyPlane);
        DrawGrass();
        DrawSun();

      }
      function DrawGrass(){
          var newplane = new THREE.Mesh( new THREE.PlaneGeometry(window.innerWidth,255), new THREE.MeshLambertMaterial({color: 0x003300}));
          newplane.position.z +=30;
          newplane.rotation.x = - Math.PI / 2;
          scene.add(newplane);
      }

      function DrawSun(){
        scene.add(new THREE.HemisphereLight(app.skyColor, 0x00FF00, 5))
        var sunsphere = new THREE.Mesh( new THREE.SphereGeometry(100,100,100), new THREE.MeshLambertMaterial({color: 'yellow'}));
        sunsphere.position.z=-200;
        scene.add(sunsphere);
      }

      function generateBirds(){
        window.numBirds = 25;
        window.birds = [];
        window.deadBirds = [];
        var bird;
        for( var i = 0; i < window.numBirds; i++){
          bird = new THREE.Mesh( new THREE.SphereGeometry(3,10,10), new THREE.MeshLambertMaterial({color:'red'}));
          bird.position.set(40, Math.floor(Math.random() * (70-40)+40),Math.floor(Math.random() * (110-60)+60));
          bird.velocity = {
            x: Math.random()*(1-0.3)+0.3
            // y: Math.random()/10
          }
          birds.push(bird);
          scene.add(bird);
        }
      }

      function generateGun(){
        var gun = new THREE.Mesh( new THREE.BoxGeometry(40,5,5), new THREE.MeshLambertMaterial({color:'brown'}));
        gun.position.set(0,40,170);
        window.Gun = gun;
        scene.add(gun);
      }
      
      function onMouseMove(e){
        app.vertLook = e.y/window.innerHeight;
        app.horzLook = e.x/window.innerWidth;

        mouse.x = 2 * (e.clientX / window.innerWidth) -1;
        mouse.y = 1 - 2 * (e.clientY / window.innerHeight);

        var raycaster = projector.pickingRay( mouse.clone(), camera );
        window.intersects = raycaster.intersectObjects( birds );

        document.body.style.cursor = 'crosshair';
      }
      
      function onMouseDown(e){
        e.preventDefault();
        if ( intersects.length > 0 ) {
          deadBirds.push(intersects[0].object);
          scene.remove(intersects[0].object)
        }
        console.log(deadBirds);        
      }
      
      function onMouseUp(e){
        e.preventDefault();
      }


      //

      function animate() {
        requestAnimationFrame( animate );
        render();
      }

      function flyBirds(){
        for(var i = 0; i < window.birds.length; i++) {
          if(birds[i].position.x > (window.innerWidth / 10)) {
            birds[i].position.x = (-window.innerWidth / 10);            
          }
          else {
            birds[i].position.x += birds[i].velocity.x;             
            // birds[i].position.y += birds[i].velocity.y * Math.floor(Math.random()*2+1);
          }
        }
      }
      function render() {

        var time = Date.now() / 6000;

        camera.lookAt( scene.position );
        // camera.rotateX((1 - vertLook) *Math.PI/2)
        Gun.lookAt( scene.position );
        Gun.rotateY((((app.horzLook)*-2))* Math.PI/2);
        Gun.rotateZ((1 - app.vertLook) * (Math.PI - 2)/2);
        Gun.rotateY(0);
        flyBirds();

        renderer.render( scene, camera );

      }

    </script>

  </body>
</html>
